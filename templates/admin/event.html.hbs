<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin · Event</title>
  <link rel="stylesheet" href="/static/css/bootstrap.css"/>
  <link rel="stylesheet" href="/static/css/app.css"/>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
  <div class="container">
    <a class="navbar-brand" href="/">FESD</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/admin">Back to dashboard</a></li>
        <li class="nav-item">
          <form action="/logout" method="post" class="d-inline">
            <button class="btn btn-sm btn-outline-secondary" type="submit">Logout</button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <div class="d-flex align-items-center mb-3">
    <h1 class="h3 mb-0">Manage event: {{event.name}}</h1>
    <span class="ms-3 badge bg-info text-dark">{{event.state}}</span>
  </div>
  {{#if event.description}}
    <p class="mb-4">{{event.description}}</p>
  {{/if}}

  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-header">Event actions</div>
        <div class="card-body">
          <form action="/admin/events/{{event.uuid}}/state" method="post" class="mb-3">
            <div class="mb-2">
              <label for="state" class="form-label">State</label>
              <select id="state" name="state" class="form-select">
                <option value="NotOpenedYet">NotOpenedYet</option>
                <option value="OpenForRegistration">OpenForRegistration</option>
              </select>
            </div>
            <button class="btn btn-sm btn-primary" type="submit">Update state</button>
          </form>

          {{#if can_close_and_distribute}}
          <form action="/admin/events/{{event.uuid}}/close_and_distribute" method="post" class="mb-3" onsubmit="return confirm('Close registrations and start seat distribution?');">
            <button class="btn btn-sm btn-warning" type="submit">Close registrations & distribute seats</button>
          </form>
          {{/if}}

          <form action="/admin/events/{{event.uuid}}/delete" method="post" onsubmit="return confirm('Delete this event? This cannot be undone.');">
            <button class="btn btn-sm btn-danger" type="submit">Delete event</button>
          </form>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">Create new slot</div>
        <div class="card-body">
          <form action="/admin/events/{{event.uuid}}/slots" method="post">
            <div class="mb-2">
              <label for="slot-name" class="form-label">Name</label>
              <input id="slot-name" name="name" type="text" class="form-control" required />
            </div>
            <div class="mb-2">
              <label for="slot-desc" class="form-label">Description (optional)</label>
              <textarea id="slot-desc" name="description" class="form-control" rows="2"></textarea>
            </div>
            <button class="btn btn-sm btn-success" type="submit">Add slot</button>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Invitation codes</div>
        <div class="card-body">
          <h6 class="mb-2">Existing codes</h6>
          {{#if invite_codes.[0]}}
          <ul class="list-group mb-3">
            {{#each invite_codes}}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <code>{{this}}</code>
              <form action="/admin/events/{{../event.uuid}}/invites/{{this}}/delete" method="post" class="ms-2" onsubmit="return confirm('Delete invite code {{this}}?');">
                <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
              </form>
            </li>
            {{/each}}
          </ul>
          {{else}}
            <p class="text-muted">No invitation codes for this event yet.</p>
          {{/if}}

          <h6 class="mb-2">Add codes in bulk</h6>
          <form action="/admin/events/{{event.uuid}}/invites/bulk" method="post">
            <div class="mb-2">
              <label for="codes" class="form-label">One code per line</label>
              <textarea id="codes" name="codes" class="form-control" rows="6" placeholder="CODE-1" required></textarea>
            </div>
            <button class="btn btn-sm btn-primary" type="submit">Add codes</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">Slots and sessions</div>
        <div class="card-body">
          <div class="accordion" id="slots">
            {{#each view_slots}}
            <div class="accordion-item mb-2">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#slot-{{this.uuid}}">
                  {{this.name}}
                </button>
              </h2>
              <div id="slot-{{this.uuid}}" class="accordion-collapse collapse" data-bs-parent="#slots">
                <div class="accordion-body">
                  {{#if this.description}}<p class="text-muted">{{this.description}}</p>{{/if}}
                  <div class="mb-3">
                    <form action="/admin/events/{{../event.uuid}}/slots/{{this.uuid}}/edit" method="post" class="row g-2 align-items-end">
                      <div class="col-md-4">
                        <label class="form-label">Name</label>
                        <input name="name" type="text" class="form-control" value="{{this.name}}" required />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Description</label>
                        <input name="description" type="text" class="form-control" value="{{this.description}}" />
                      </div>
                      <div class="col-md-2 d-grid">
                        <button class="btn btn-primary" type="submit">Save</button>
                      </div>
                    </form>
                    <form action="/admin/events/{{../event.uuid}}/slots/{{this.uuid}}/delete" method="post" class="mt-2" onsubmit="return confirm('Delete this slot and all its sessions?');">
                      <button class="btn btn-outline-danger btn-sm" type="submit">Delete slot</button>
                    </form>
                  </div>

                  <hr/>
                  <h6>Create session</h6>
                  <form action="/admin/events/{{../event.uuid}}/slots/{{this.uuid}}/sessions" method="post" class="row g-2 mb-3 align-items-end">
                    <div class="col-md-4">
                      <label class="form-label">Name</label>
                      <input name="name" type="text" class="form-control" required />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Description</label>
                      <input name="description" type="text" class="form-control" />
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Seats</label>
                      <input name="seats" type="number" min="1" max="10000" class="form-control" required />
                    </div>
                    <div class="col-md-2 d-grid">
                      <button class="btn btn-success" type="submit">Add</button>
                    </div>
                  </form>

                  <div class="table-responsive">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>Session</th>
                          <th style="width: 160px;">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                      {{#each this.sessions}}
                        <tr>
                          <td>
                            <form action="/admin/events/{{../../event.uuid}}/slots/{{../uuid}}/sessions/{{this.uuid}}/edit" method="post" class="row g-2 align-items-center">
                              <div class="col-md-4">
                                <input name="name" type="text" class="form-control form-control-sm" value="{{this.name}}" required />
                              </div>
                              <div class="col-md-4">
                                <input name="description" type="text" class="form-control form-control-sm" value="{{this.description}}" />
                              </div>
                              <div class="col-md-2">
                                <input name="seats" type="number" min="1" max="10000" class="form-control form-control-sm" value="{{this.seats}}" required />
                              </div>
                              <div class="col-md-2 d-grid">
                                <button class="btn btn-primary btn-sm" type="submit">Save</button>
                              </div>
                            </form>
                            {{#if ../../is_finished}}
                              <div class="mt-2">
                                <div class="small text-muted">Assigned participants:</div>
                                {{#if this.assigned_names.[0]}}
                                  <ul class="mb-0">
                                    {{#each this.assigned_names}}
                                      <li>{{this}}</li>
                                    {{/each}}
                                  </ul>
                                {{else}}
                                  <div class="text-muted small">— none —</div>
                                {{/if}}
                              </div>
                            {{/if}}
                          </td>
                          <td>
                            <form action="/admin/events/{{../../event.uuid}}/slots/{{../uuid}}/sessions/{{this.uuid}}/delete" method="post" onsubmit="return confirm('Delete this session?');" class="d-grid">
                              <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
                            </form>
                          </td>
                        </tr>
                      {{else}}
                        <tr><td colspan="2" class="text-muted">No sessions yet.</td></tr>
                      {{/each}}
                      </tbody>
                    </table>
                  </div>

                </div>
              </div>
            </div>
            {{else}}
              <p class="text-muted">No slots yet.</p>
            {{/each}}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  (function() {
    const container = document.getElementById('slots');
    if (!container) return;

    function openById(id) {
      const target = document.getElementById(id);
      if (!target) return;
      const btn = container.querySelector('[data-bs-target="#' + CSS.escape(id) + '"]');
      // Close all first (respect data-bs-parent semantics)
      container.querySelectorAll('.accordion-collapse.show').forEach(el => el.classList.remove('show'));
      container.querySelectorAll('.accordion-button').forEach(b => b.classList.add('collapsed'));
      target.classList.add('show');
      if (btn) btn.classList.remove('collapsed');
    }

    container.addEventListener('click', function(e) {
      const btn = e.target.closest('.accordion-button');
      if (!btn || !container.contains(btn)) return;
      e.preventDefault();
      const selector = btn.getAttribute('data-bs-target');
      if (!selector) return;
      const target = document.querySelector(selector);
      if (!target) return;
      const isOpen = target.classList.contains('show');

      // Close all panels
      container.querySelectorAll('.accordion-collapse.show').forEach(el => el.classList.remove('show'));
      container.querySelectorAll('.accordion-button').forEach(b => b.classList.add('collapsed'));

      if (!isOpen) {
        target.classList.add('show');
        btn.classList.remove('collapsed');
        if (target.id) {
          try { history.replaceState(null, '', '#' + target.id); } catch (_) {}
        }
      } else {
        // If closing the current one, clear hash
        if (location.hash === '#' + target.id) {
          try { history.replaceState(null, '', ' '); } catch (_) {}
        }
      }
    });

    // Open panel from URL hash on load, if present
    if (location.hash && location.hash.length > 1) {
      const id = decodeURIComponent(location.hash.substring(1));
      if (document.getElementById(id)) {
        openById(id);
      }
    }
  })();
</script>
</body>
</html>
